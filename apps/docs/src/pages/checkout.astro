---
import LandingLayout from '../layouts/LandingLayout.astro';

const title = 'Checkout - AgencyOS';
const description = 'Complete your AgencyOS subscription.';

// PayPal Plan Mapping
const PAYPAL_PLANS = {
  starter: 'P-7DA230130F8006938NFYLZDA',
  pro: 'P-95T479827M227991CNFYLZDI',
  franchise: 'P-0KK81193UG062012VNFYLZDI',
  enterprise: 'P-92J98622GM186390LNFYLZDQ'
};

const API_BASE = "https://api.mekong.agency/api/v1"; // Update with production API
---

<LandingLayout title={title} description={description}>
  <section class="checkout-section">
    <div class="checkout-card">
      
      <!-- Loading State -->
      <div class="loading-state" id="loading-state">
        <div class="spinner"></div>
        <h2>Preparing Checkout...</h2>
        <p>Redirecting to secure PayPal payment...</p>
      </div>

      <!-- Error State -->
      <div class="error-state hidden" id="error-state">
        <span class="error-icon">⚠️</span>
        <h2>Something went wrong</h2>
        <p id="error-message">Unable to process checkout.</p>
        <a href="/pricing" class="btn-primary">← Back to Pricing</a>
      </div>

    </div>
  </section>
</LandingLayout>

<style>
  .checkout-section {
    min-height: 70vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    position: relative;
  }

  .checkout-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 48px;
    text-align: center;
    max-width: 500px;
    width: 100%;
    animation: card-entrance 0.6s ease-out forwards;
    box-shadow: 0 0 30px rgba(34, 197, 94, 0.15);
  }

  @keyframes card-entrance {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .loading-state, .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .spinner {
    width: 56px;
    height: 56px;
    border: 4px solid var(--color-bg-tertiary);
    border-top-color: #22c55e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .hidden {
    display: none !important;
  }

  .btn-primary {
    display: inline-block;
    padding: 14px 28px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    margin-top: 8px;
  }

  .trust-badges {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  .badge-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }

  .badge-item .icon {
    font-size: 1.2rem;
  }
</style>

<script define:vars={{ API_BASE }}>
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const errorMessage = document.getElementById('error-message');

  const urlParams = new URLSearchParams(window.location.search);
  const plan = urlParams.get('plan') || 'pro';
  const email = urlParams.get('email');

  function showError(message) {
    if (loadingState) loadingState.classList.add('hidden');
    if (errorState) errorState.classList.remove('hidden');
    if (errorMessage) errorMessage.textContent = message;
  }

  async function redirectToPayPal() {
    try {
      // Use internal API to create PayPal order/subscription
      // For now, redirecting to a payment session creator
      const response = await fetch(`${API_BASE}/payments/paypal/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: plan === 'starter' ? 29 : (plan === 'pro' ? 99 : 299),
          currency: 'USD',
          description: `AgencyOS ${plan.charAt(0).toUpperCase() + plan.slice(1)} Plan`,
          customer_email: email,
          tenant_id: email
        })
      });
      
      const data = await response.json();
      
      if (data.orderId && data.details) {
        const approvalUrl = data.details.links.find(l => l.rel === 'approve')?.href;
        if (approvalUrl) {
          window.location.href = approvalUrl;
        } else {
          showError('PayPal approval link not found.');
        }
      } else {
        showError(data.error || 'Failed to initiate PayPal checkout.');
      }
    } catch (error) {
      showError('Network error connecting to payment gateway.');
    }
  }

  setTimeout(redirectToPayPal, 1000);
</script>
