---
import LandingLayout from '../layouts/LandingLayout.astro';
import { getLocaleFromUrl, useTranslations, getRelativeLocaleUrl } from '@agencyos/i18n/astro';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

const title = t('dashboard_page.title');
const description = t('dashboard_page.description');
---

<LandingLayout title={title} description={description}>
  <section class="dashboard-section">

    <!-- Loading State -->
    <div class="loading-state" id="loading-state">
      <div class="spinner"></div>
      <p>{t('dashboard_page.loading')}</p>
    </div>

    <!-- Not Authenticated -->
    <div class="auth-required hidden" id="auth-required">
      <div class="auth-card">
        <span class="lock-icon">üîí</span>
        <h2>{t('dashboard_page.auth_required.title')}</h2>
        <p>{t('dashboard_page.auth_required.subtitle')}</p>
        <div class="auth-actions">
          <a href={getRelativeLocaleUrl(locale, '/signup?plan=starter')} class="btn-primary">{t('dashboard_page.auth_required.primary')}</a>
          <a href={getRelativeLocaleUrl(locale, '/pricing')} class="btn-secondary">{t('dashboard_page.auth_required.secondary')}</a>
        </div>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content hidden" id="dashboard-content">

      <!-- Welcome Header -->
      <div class="dashboard-header">
        <div class="welcome-section">
          <h1>{t('dashboard_page.header.welcome').replace('{name}', '<span id="user-name">' + t('dashboard_page.header.default_name') + '</span>')}</h1>
          <p class="user-email" id="user-email"></p>
        </div>
        <div class="plan-badge" id="plan-badge">
          <span class="plan-icon">‚≠ê</span>
          <span class="plan-name">Starter</span>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ü§ñ</div>
          <div class="stat-info">
            <div class="stat-value">125+</div>
            <div class="stat-label">{t('dashboard_page.stats.commands')}</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-info">
            <div class="stat-value" id="trial-days">7</div>
            <div class="stat-label">{t('dashboard_page.stats.trial_left')}</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üöÄ</div>
          <div class="stat-info">
            <div class="stat-value">{t('dashboard_page.stats.active')}</div>
            <div class="stat-label">{t('dashboard_page.stats.status')}</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="actions-section">
        <h2>{t('dashboard_page.sections.get_started')}</h2>
        <div class="actions-grid">

          <a href={getRelativeLocaleUrl(locale, '/docs/getting-started/quick-start')} class="action-card">
            <div class="action-icon">üìñ</div>
            <div class="action-content">
              <h3>{t('dashboard_page.sections.guides.title')}</h3>
              <p>{t('dashboard_page.sections.guides.desc')}</p>
            </div>
            <span class="arrow">‚Üí</span>
          </a>

          <a href={getRelativeLocaleUrl(locale, '/demo')} class="action-card">
            <div class="action-icon">üíª</div>
            <div class="action-content">
              <h3>{t('dashboard_page.sections.demo.title')}</h3>
              <p>{t('dashboard_page.sections.demo.desc')}</p>
            </div>
            <span class="arrow">‚Üí</span>
          </a>

          <a href={getRelativeLocaleUrl(locale, '/commands')} class="action-card">
            <div class="action-icon">üìã</div>
            <div class="action-content">
              <h3>{t('dashboard_page.sections.catalog.title')}</h3>
              <p>{t('dashboard_page.sections.catalog.desc')}</p>
            </div>
            <span class="arrow">‚Üí</span>
          </a>

          <a href="mailto:support@agencyos.network" class="action-card">
            <div class="action-icon">üí¨</div>
            <div class="action-content">
              <h3>{t('dashboard_page.sections.support.title')}</h3>
              <p>{t('dashboard_page.sections.support.desc')}</p>
            </div>
            <span class="arrow">‚Üí</span>
          </a>

        </div>
      </div>

      <!-- CLI Setup Box -->
      <div class="setup-box">
        <h3>{t('dashboard_page.install.title')}</h3>
        <div class="code-block">
          <code>pip install mekong-cli</code>
          <button class="copy-btn" data-cmd="pip install mekong-cli">{t('dashboard_page.install.copy')}</button>
        </div>
        <p class="setup-note">
          {t('dashboard_page.install.note').split('{link}')[0]}
          <a href={getRelativeLocaleUrl(locale, '/docs/getting-started/installation')}>{t('nav.getting-started')}</a>
          {t('dashboard_page.install.note').split('{link}')[1]}
        </p>
      </div>

    </div>
  </section>

  <div id="dashboard-i18n"
    data-welcome-template={t('dashboard_page.header.welcome')}
  ></div>
</LandingLayout>

<style>
  .dashboard-section {
    max-width: 1000px;
    margin: 0 auto;
    padding: 32px 24px;
    min-height: 70vh;
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
    gap: 16px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-bg-tertiary);
    border-top-color: #22c55e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .hidden { display: none !important; }

  /* Auth Required */
  .auth-required {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
  }

  .auth-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 48px;
    text-align: center;
    max-width: 400px;
  }

  .lock-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 16px;
  }

  .auth-card h2 {
    font-size: 1.5rem;
    margin: 0 0 8px 0;
    color: var(--color-text-primary);
  }

  .auth-card p {
    color: var(--color-text-muted);
    margin: 0 0 24px 0;
  }

  .auth-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .btn-primary {
    padding: 14px 24px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
  }

  .btn-secondary {
    padding: 14px 24px;
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
  }

  /* Dashboard Content */
  .dashboard-content {
    animation: fade-in 0.5s ease-out;
  }

  @keyframes fade-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .welcome-section h1 {
    font-size: 1.75rem;
    margin: 0;
    color: var(--color-text-primary);
  }

  .user-email {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin: 4px 0 0 0;
  }

  .plan-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(6, 182, 212, 0.1));
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 24px;
  }

  .plan-icon { font-size: 1.25rem; }
  .plan-name { font-weight: 600; color: #22c55e; }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }

  .stat-icon { font-size: 2rem; }
  .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-text-primary); }
  .stat-label { font-size: 0.85rem; color: var(--color-text-muted); }

  /* Actions */
  .actions-section h2 {
    font-size: 1.25rem;
    margin: 0 0 16px 0;
    color: var(--color-text-primary);
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .action-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .action-card:hover {
    border-color: #22c55e;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .action-icon { font-size: 1.5rem; }
  .action-content h3 { margin: 0; font-size: 1rem; color: var(--color-text-primary); }
  .action-content p { margin: 4px 0 0 0; font-size: 0.85rem; color: var(--color-text-muted); }
  .arrow { margin-left: auto; color: var(--color-text-muted); }

  /* Setup Box */
  .setup-box {
    padding: 24px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }

  .setup-box h3 {
    margin: 0 0 16px 0;
    color: var(--color-text-primary);
  }

  .code-block {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    font-family: monospace;
  }

  .code-block code {
    flex: 1;
    color: #22c55e;
    font-size: 1rem;
  }

  .copy-btn {
    padding: 8px 16px;
    background: #22c55e;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .setup-note {
    margin: 12px 0 0 0;
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .setup-note a {
    color: #22c55e;
  }

  @media (max-width: 600px) {
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<script>
  const loadingState = document.getElementById('loading-state');
  const authRequired = document.getElementById('auth-required');
  const dashboardContent = document.getElementById('dashboard-content');
  const userName = document.getElementById('user-name');
  const userEmail = document.getElementById('user-email');
  const planBadge = document.getElementById('plan-badge');
  const trialDays = document.getElementById('trial-days');

  const PLAN_CONFIG = {
    starter: { name: 'Starter', icon: '‚≠ê' },
    pro: { name: 'Pro', icon: 'üöÄ' },
    franchise: { name: 'Franchise', icon: 'üèØ' }
  };

  function checkAuth() {
    // Check localStorage for user data from checkout/signup
    const userData = localStorage.getItem('agencyos_user');
    
    setTimeout(() => {
      if (loadingState) loadingState.classList.add('hidden');
      
      if (userData) {
        try {
          const user = JSON.parse(userData);
          showDashboard(user);
        } catch (e) {
          showAuthRequired();
        }
      } else {
        showAuthRequired();
      }
    }, 800);
  }

  function showAuthRequired() {
    if (authRequired) authRequired.classList.remove('hidden');
  }

  function showDashboard(user: any) {
    if (dashboardContent) dashboardContent.classList.remove('hidden');
    
    // Populate user info
    if (userName && user.name) {
      userName.textContent = user.name.split(' ')[0]; // First name only
    }
    if (userEmail && user.email) {
      userEmail.textContent = user.email;
    }
    
    // Update plan badge
    const plan = user.plan || 'starter';
    const config = PLAN_CONFIG[plan as keyof typeof PLAN_CONFIG] || PLAN_CONFIG.starter;
    if (planBadge) {
      const icon = planBadge.querySelector('.plan-icon');
      const name = planBadge.querySelector('.plan-name');
      if (icon) icon.textContent = config.icon;
      if (name) name.textContent = config.name;
    }

    // Calculate trial days remaining
    if (trialDays && user.timestamp) {
      const signupDate = new Date(user.timestamp);
      const now = new Date();
      const daysPassed = Math.floor((now.getTime() - signupDate.getTime()) / (1000 * 60 * 60 * 24));
      const remaining = Math.max(0, 7 - daysPassed);
      trialDays.textContent = remaining.toString();
    }
  }

  // Run on page load
  checkAuth();
</script>
