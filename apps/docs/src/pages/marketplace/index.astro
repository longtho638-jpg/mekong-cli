---
import LandingLayout from '../../layouts/LandingLayout.astro';
import { getLocaleFromUrl, useTranslations, getRelativeLocaleUrl } from '@agencyos/i18n/astro';
import { locales } from '@agencyos/i18n/locales';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

const title = t('marketplace_page.title');
const description = t('marketplace_page.description');

const pageData = (locales[locale] as any).marketplace_page;

// Helper to get localized product data
const getProduct = (id: string) => ({
  ...pageData.products[id],
  id
});

const products = [
  { ...getProduct('seo_audit'), icon: 'üîç', type: 'skill', rating: '4.8', downloads: '245', price: '$49' },
  { ...getProduct('invoice'), icon: 'üìÑ', type: 'skill', rating: '4.6', downloads: '189', price: '$29' },
  { ...getProduct('proposal'), icon: 'üìã', type: 'template', rating: '4.9', downloads: '156', price: '$79' },
  { ...getProduct('social_agent'), icon: 'üì±', type: 'agent', rating: '4.7', downloads: '98', price: '$99' },
  { ...getProduct('onboarding'), icon: 'üöÄ', type: 'workflow', rating: '4.8', downloads: '67', price: '$149' },
  { ...getProduct('content_calendar'), icon: 'üìÖ', type: 'skill', rating: '4.5', downloads: '512', price: 'FREE' },
];
---

<LandingLayout title={title} description={description}>
  <section class="marketplace-section">
    <div class="marketplace-header">
      <h1 set:html={pageData.hero.title}></h1>
      <p class="subtitle">{pageData.hero.subtitle}</p>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number" id="total-items">6</span>
        <span class="stat-label">{pageData.stats.products}</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="total-downloads">1,267</span>
        <span class="stat-label">{pageData.stats.downloads}</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="total-creators">25</span>
        <span class="stat-label">{pageData.stats.creators}</span>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-tabs">
        <button class="filter-tab active" data-type="all">{pageData.filters.all}</button>
        <button class="filter-tab" data-type="skill">{pageData.filters.skill}</button>
        <button class="filter-tab" data-type="template">{pageData.filters.template}</button>
        <button class="filter-tab" data-type="agent">{pageData.filters.agent}</button>
        <button class="filter-tab" data-type="workflow">{pageData.filters.workflow}</button>
      </div>
      <div class="filter-right">
        <select id="sort-select" class="sort-select">
          <option value="popular">{pageData.filters.sort.popular}</option>
          <option value="newest">{pageData.filters.sort.newest}</option>
          <option value="rating">{pageData.filters.sort.rating}</option>
          <option value="price-low">{pageData.filters.sort.price_low}</option>
          <option value="price-high">{pageData.filters.sort.price_high}</option>
        </select>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid" id="products-grid">
      {products.map(product => (
        <div class="product-card" data-type={product.type}>
          <div class="product-icon">{product.icon}</div>
          <div class={`product-badge ${product.price === 'FREE' ? 'free' : product.type}`}>
            {product.price === 'FREE' ? pageData.product.badges.free : pageData.product.badges[product.type]}
          </div>
          <h3>{product.title}</h3>
          <p class="product-desc">{product.desc}</p>
          <div class="product-meta">
            <span class="rating">‚≠ê {product.rating}</span>
            <span class="downloads">{product.downloads} {pageData.product.downloads}</span>
          </div>
          <div class="product-footer">
            <span class={`price ${product.price === 'FREE' ? 'free' : ''}`}>
              {product.price === 'FREE' ? pageData.product.free : product.price}
            </span>
            <button class={`btn-buy ${product.price === 'FREE' ? 'free' : ''}`}>
              {product.price === 'FREE' ? pageData.product.get_free : pageData.product.add_to_cart}
            </button>
          </div>
        </div>
      ))}
    </div>

    <!-- Become Creator CTA -->
    <div class="creator-cta">
      <h2>{pageData.creator_cta.title}</h2>
      <p>{pageData.creator_cta.desc}</p>
      <a href={getRelativeLocaleUrl(locale, '/marketplace/submit')} class="btn-primary">{pageData.creator_cta.button}</a>
    </div>
  </section>

  <div id="marketplace-i18n"
    data-added-free={pageData.alerts.added_free}
    data-added-cart={pageData.alerts.added_cart}
  ></div>
</LandingLayout>

<style>
  .marketplace-section {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  .marketplace-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .marketplace-header h1 {
    font-size: 2.5rem;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .subtitle { color: var(--color-text-muted); font-size: 1.1rem; }

  .stats-bar {
    display: flex;
    justify-content: center;
    gap: 48px;
    padding: 24px;
    background: var(--color-bg-secondary);
    border-radius: 16px;
    margin-bottom: 32px;
  }

  .stat-item { text-align: center; }

  .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text-primary);
  }

  .stat-label { color: var(--color-text-muted); font-size: 0.9rem; }

  .filters {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .filter-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .filter-tab {
    padding: 10px 20px;
    border-radius: 8px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-tab:hover, .filter-tab.active {
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    color: white;
    border-color: transparent;
  }

  .sort-select {
    padding: 10px 16px;
    border-radius: 8px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
    font-size: 0.9rem;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 48px;
  }

  .product-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
    transition: all 0.3s;
  }

  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    border-color: #f59e0b;
  }

  .product-icon {
    font-size: 2.5rem;
    margin-bottom: 16px;
  }

  .product-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
  }

  .product-badge.skill { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
  .product-badge.template { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
  .product-badge.agent { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
  .product-badge.workflow { background: rgba(249, 115, 22, 0.2); color: #f97316; }
  .product-badge.free { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

  .product-card h3 {
    font-size: 1.25rem;
    margin: 0 0 8px 0;
  }

  .product-desc {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: 16px;
  }

  .product-meta {
    display: flex;
    gap: 16px;
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    margin-bottom: 16px;
  }

  .product-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 16px;
    border-top: 1px solid var(--color-border);
  }

  .price {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text-primary);
  }

  .price.free { color: #22c55e; }

  .btn-buy {
    padding: 10px 20px;
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-buy:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249, 115, 22, 0.3);
  }

  .btn-buy.free {
    background: linear-gradient(135deg, #22c55e, #16a34a);
  }

  .creator-cta {
    text-align: center;
    padding: 48px;
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(239, 68, 68, 0.1));
    border-radius: 16px;
    border: 1px solid rgba(249, 115, 22, 0.2);
  }

  .creator-cta h2 { margin: 0 0 12px 0; font-size: 1.75rem; }
  .creator-cta p { color: var(--color-text-muted); margin-bottom: 24px; }

  .btn-primary {
    display: inline-block;
    padding: 14px 28px;
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(249, 115, 22, 0.4);
  }

  @media (max-width: 768px) {
    .stats-bar { flex-direction: column; gap: 24px; }
    .filters { flex-direction: column; }
    .filter-tabs { justify-content: center; }
  }
</style>

<script>
  // Filter tabs
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const type = (tab as HTMLElement).dataset.type;
      document.querySelectorAll('.product-card').forEach(card => {
        const cardType = (card as HTMLElement).dataset.type;
        if (type === 'all' || cardType === type) {
          (card as HTMLElement).style.display = 'block';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });
  });

  // Buy buttons
  document.querySelectorAll('.btn-buy').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.product-card');
      const name = card?.querySelector('h3')?.textContent;
      const price = card?.querySelector('.price')?.textContent;
      
      if (price === 'FREE') {
        alert(`‚úÖ "${name}" added to your library!\n\nYou can access it from your dashboard.`);
      } else {
        alert(`üõí "${name}" added to cart!\n\nPrice: ${price}\n\nCheckout coming soon.`);
      }
    });
  });
</script>
