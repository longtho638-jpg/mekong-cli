---
import LandingLayout from '../layouts/LandingLayout.astro';
import { getLocaleFromUrl, useTranslations, getRelativeLocaleUrl } from '@agencyos/i18n/astro';
import { locales } from '@agencyos/i18n/locales';

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

const title = t('signup_page.title');
const description = t('signup_page.description');

const pageData = (locales[locale] as any).signup_page;
---

<LandingLayout title={title} description={description}>
  <section class="signup-hero">
    <h1>{pageData.hero.title}</h1>
    <p>{pageData.hero.subtitle}</p>
  </section>

  <section class="signup-section">
    <div class="signup-card">

      <div class="plan-selected" id="plan-badge">
        <span class="plan-icon">‚≠ê</span>
        <span class="plan-name">Pro Plan</span>
        <span class="plan-price" id="plan-price">$99/month</span>
      </div>

      <form id="signup-form" class="signup-form">

        <div class="form-group">
          <label for="email">{pageData.form.email_label}</label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder={pageData.form.email_placeholder}
            required
          />
        </div>

        <div class="form-group">
          <label for="name">{pageData.form.name_label}</label>
          <input
            type="text"
            id="name"
            name="name"
            placeholder={pageData.form.name_placeholder}
            required
          />
        </div>

        <div class="form-group">
          <label for="promo">{pageData.form.promo_label}</label>
          <div class="promo-input-group">
            <input
              type="text"
              id="promo"
              name="promo"
              placeholder={pageData.form.promo_placeholder}
            />
            <button type="button" id="apply-promo" class="btn-apply">{pageData.form.apply_button}</button>
          </div>
          <div id="promo-status" class="promo-status"></div>
        </div>

        <div class="price-summary" id="price-summary">
          <div class="summary-row">
            <span id="plan-summary-label">Pro Plan (Monthly)</span>
            <span id="original-price">$99.00</span>
          </div>
          <div class="summary-row discount hidden" id="discount-row">
            <span>{pageData.form.discount}</span>
            <span id="discount-amount" class="text-green">-$0.00</span>
          </div>
          <div class="summary-row total">
            <span>{pageData.form.total}</span>
            <span id="total-price">$99.00</span>
          </div>
        </div>

        <button type="submit" class="btn-primary" id="submit-btn">
          {pageData.form.submit_button}
        </button>

        <p class="terms-text">
          {pageData.form.terms_prefix}
          <a href={getRelativeLocaleUrl(locale, '/terms')}>{pageData.form.terms_link}</a> {pageData.form.and}
          <a href={getRelativeLocaleUrl(locale, '/privacy')}>{pageData.form.privacy_link}</a>.
        </p>

      </form>

      <div class="benefits-list">
        <h4>{pageData.benefits.title}</h4>
        <ul>
          {pageData.benefits.items.map((item: string) => (
            <li>‚úÖ {item}</li>
          ))}
        </ul>
      </div>

    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas"></canvas>
  </section>

  <div id="signup-i18n"
    data-promo-applied={pageData.form.promo_applied}
    data-promo-invalid={pageData.form.promo_invalid}
    data-checkout-url={getRelativeLocaleUrl(locale, '/checkout')}
  ></div>
</LandingLayout>

<style>
  /* ===================== WOW SIGNUP ANIMATIONS ===================== */
  .signup-hero {
    text-align: center;
    padding: 64px 24px 32px;
    animation: hero-fade-in 0.6s ease-out;
  }

  @keyframes hero-fade-in {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .signup-hero h1 {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #22c55e, #06b6d4, #22c55e);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 16px;
    animation: text-shine 4s linear infinite;
  }

  @keyframes text-shine {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }

  .signup-hero p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    animation: hero-fade-in 0.8s ease-out 0.2s both;
  }

  .signup-section {
    max-width: 500px;
    margin: 0 auto;
    padding: 24px;
  }

  .signup-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 32px;
    position: relative;
    overflow: hidden;
    animation: card-entrance 0.7s ease-out 0.3s both;
  }

  @keyframes card-entrance {
    from { opacity: 0; transform: translateY(40px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .plan-selected {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--color-bg-tertiary);
    border-radius: 12px;
    margin-bottom: 24px;
    position: relative;
    z-index: 1;
    animation: slide-in 0.5s ease-out 0.5s both;
  }

  @keyframes slide-in {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .plan-icon {
    font-size: 1.5rem;
    animation: star-pulse 2s ease-in-out infinite;
  }

  @keyframes star-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  .plan-name {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .plan-price {
    margin-left: auto;
    color: #22c55e;
    font-weight: 700;
  }

  .signup-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    z-index: 1;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    animation: fade-up 0.5s ease-out both;
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 0.9rem;
  }

  .form-group input {
    padding: 14px 16px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text-primary);
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: #22c55e;
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
    transform: scale(1.01);
  }

  .promo-input-group {
    display: flex;
    gap: 8px;
  }

  .promo-input-group input {
    flex: 1;
  }

  .btn-apply {
    padding: 14px 20px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .promo-status {
    font-size: 0.85rem;
    min-height: 20px;
  }

  .promo-status.success { color: #22c55e; }
  .promo-status.error { color: #ef4444; }

  .price-summary {
    background: var(--color-bg-tertiary);
    border-radius: 12px;
    padding: 16px;
    animation: fade-up 0.5s ease-out 0.9s both;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
  }

  .summary-row.total {
    border-top: 1px solid var(--color-border);
    margin-top: 8px;
    padding-top: 16px;
    font-weight: 700;
    color: var(--color-text-primary);
  }

  .text-green { color: #22c55e; }
  .hidden { display: none; }

  .btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    animation: fade-up 0.5s ease-out 1s both;
  }

  .terms-text {
    text-align: center;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .benefits-list {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border);
  }

  #confetti-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
  }
</style>

<script>
  const form = document.getElementById('signup-form') as HTMLFormElement;
  const promoInput = document.getElementById('promo') as HTMLInputElement;
  const applyPromoBtn = document.getElementById('apply-promo');
  const promoStatus = document.getElementById('promo-status');
  const discountRow = document.getElementById('discount-row');
  const discountAmount = document.getElementById('discount-amount');
  const totalPriceEl = document.getElementById('total-price');
  const planPriceEl = document.getElementById('plan-price');
  // const submitBtn = document.getElementById('submit-btn');

  const PLAN_CONFIG = {
    starter: { name: 'Starter Plan', price: 29, icon: '‚≠ê' },
    pro: { name: 'Pro Plan', price: 99, icon: 'üöÄ' },
    franchise: { name: 'Franchise Plan', price: 299, icon: 'üèØ' }
  };

  const urlParams = new URLSearchParams(window.location.search);
  const planParam = urlParams.get('plan') || 'pro';
  const planConfig = PLAN_CONFIG[planParam as keyof typeof PLAN_CONFIG] || PLAN_CONFIG.pro;
  const ORIGINAL_PRICE = planConfig.price;

  let currentDiscount = 0;
  let validPromoCode = '';

  // Initialize UI
  if (planPriceEl) planPriceEl.textContent = `$${planConfig.price}/month`;
  if (totalPriceEl) totalPriceEl.textContent = `$${planConfig.price}.00`;

  applyPromoBtn?.addEventListener('click', async () => {
    const code = promoInput?.value.trim().toUpperCase();
    if (!code) return;

    try {
      const response = await fetch('/api/promo/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      const result = await response.json();
      if (result.valid) {
        currentDiscount = result.value;
        validPromoCode = result.code;
        updatePricing(result.value);
        if (promoStatus) {
          promoStatus.textContent = `‚úÖ Applied: ${result.value}% off!`;
          promoStatus.className = 'promo-status success';
        }
      } else {
        if (promoStatus) {
          promoStatus.textContent = '‚ùå Invalid promo code';
          promoStatus.className = 'promo-status error';
        }
      }
    } catch (e) {
      console.error(e);
    }
  });

  function updatePricing(discount: number) {
    const discountValue = (ORIGINAL_PRICE * discount / 100);
    const finalPrice = ORIGINAL_PRICE - discountValue;

    if (discount > 0 && discountRow && discountAmount) {
      discountRow.classList.remove('hidden');
      discountAmount.textContent = `-$${discountValue.toFixed(2)}`;
    }

    if (totalPriceEl) totalPriceEl.textContent = `$${finalPrice.toFixed(2)}`;
  }

  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = (document.getElementById('email') as HTMLInputElement)?.value;
    const name = (document.getElementById('name') as HTMLInputElement)?.value;

    const userData = {
      email,
      name,
      promoCode: validPromoCode,
      discount: currentDiscount,
      plan: planParam
    };

    localStorage.setItem('agencyos_user', JSON.stringify(userData));
    window.location.href = `/checkout?plan=${planParam}&email=${email}&name=${name}${validPromoCode ? '&promo=' + validPromoCode : ''}`;
  });
</script>
