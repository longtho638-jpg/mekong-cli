#!/bin/sh
# ğŸ¯ PRE-COMMIT HOOK - Binh PhÃ¡p CI Protection Layer 1
# Runs BEFORE commit is created

echo "ğŸ” Pre-commit: Running quick checks..."

# Python lint (if ruff available)
if command -v ruff &> /dev/null; then
    echo "   â†’ Ruff lint..."
    ruff check . --fix --quiet || {
        echo "âŒ Ruff lint failed. Fix errors before committing."
        exit 1
    }
fi

# TypeScript check (dashboard only - quick)
if [ -f "apps/dashboard/tsconfig.json" ]; then
    echo "   â†’ TypeScript check..."
    cd apps/dashboard
    pnpm exec tsc --noEmit --skipLibCheck 2>/dev/null || {
        echo "âŒ TypeScript errors found. Fix before committing."
        exit 1
    }
    cd ../..
fi

# Critical payment tests (fast subset only)
if [ -d "backend/tests/unit" ]; then
    echo "   â†’ Critical payment tests..."

    # Determine pytest command
    if [ -f "backend/.venv/bin/pytest" ]; then
        PYTEST_CMD="backend/.venv/bin/pytest"
    elif command -v pytest &> /dev/null; then
        PYTEST_CMD="pytest"
    else
        echo "âš ï¸  pytest not found. Skipping payment tests."
        PYTEST_CMD=""
    fi

    if [ -n "$PYTEST_CMD" ]; then
        $PYTEST_CMD backend/tests/unit/test_payment_service.py::TestCreateCheckoutSession \
               -x --tb=short --no-cov -q 2>/dev/null || {
            echo "âŒ Critical payment tests failed. DO NOT COMMIT."
            exit 1
        }
    fi
fi

echo "âœ… Pre-commit passed"
