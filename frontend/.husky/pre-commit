#!/bin/sh
# Pre-commit hook for Agency OS v2.0
# Runs quality checks before commit

echo "üîç Running pre-commit checks..."

# Get staged files
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

# 1. Run ESLint on staged TypeScript files
if [ -n "$STAGED_TS" ]; then
    echo "üìù Linting TypeScript files..."
    npx eslint $STAGED_TS --fix --quiet
    if [ $? -ne 0 ]; then
        echo "‚ùå ESLint failed. Fix errors before committing."
        exit 1
    fi
    # Add fixed files back to staging
    echo "$STAGED_TS" | xargs git add
fi

# 2. Run Prettier on staged files
echo "‚ú® Formatting code..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$')
if [ -n "$STAGED_FILES" ]; then
    echo "$STAGED_FILES" | xargs npx prettier --write --ignore-unknown
    echo "$STAGED_FILES" | xargs git add
fi

# 3. Type check (quick)
echo "üîß Type checking..."
npx tsc --noEmit --skipLibCheck 2>/dev/null
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  TypeScript warnings (non-blocking)"
fi

echo "‚úÖ Pre-commit checks passed!"
exit 0
