#!/usr/bin/env bash
# üèØ AgencyOS Unified CLI - Dispatch to all CC modules
# Usage: cc <module> <command> [args...]
# Modules: revenue, agent, devops, client, release

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
PYTHON="${PYTHON:-python3}"

# Dynamic version from package.json (Single Source of Truth)
get_version() {
    local pkg_file="$PROJECT_ROOT/package.json"
    if [[ -f "$pkg_file" ]]; then
        grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' "$pkg_file" | head -1 | sed 's/.*"\([^"]*\)"$/\1/'
    else
        echo "2.0.0"  # Fallback
    fi
}
VERSION=$(get_version)

# Module registry (9 modules)
declare -A MODULES=(
    ["revenue"]="cc_revenue.py"
    ["agent"]="cc_agent.py"
    ["devops"]="cc_devops.py"
    ["client"]="cc_client.py"
    ["release"]="cc_release.py"
    ["analytics"]="cc_analytics.py"
    ["sales"]="cc_sales.py"
    ["content"]="cc_content.py"
    ["monitor"]="cc_monitor.py"
)

# Help text
show_help() {
    cat <<EOF
üèØ AgencyOS Unified CLI (cc) v${VERSION}

Usage:
  cc <module> <command> [args...]
  cc --help
  cc --version

Available Modules:
  revenue     Revenue tracking, financial forecasting, pricing strategy
  agent       Agent management, spawning, coordination
  devops      DevOps operations, deployment, infrastructure
  client      Client management, CRM, project tracking
  release     Release management, versioning, changelog generation
  analytics   Analytics dashboard, metrics, funnel, cohort analysis
  sales       Sales pipeline, leads, forecasting, CRM-lite
  content     AI content generation, scheduling, publishing
  monitor     System monitoring, health checks, alerts

Examples:
  cc revenue forecast --mrr 10000 --growth 0.15 --months 12
  cc agent spawn --task T001 --model gemini-3-flash
  cc devops deploy --env production --service api
  cc client list --status active
  cc release bump --type minor --commit
  cc analytics dashboard
  cc analytics funnel
  cc analytics cohort --months 6
  cc analytics realtime --interval 2

Get module-specific help:
  cc revenue --help
  cc agent --help
  cc devops --help
  cc client --help
  cc release --help
  cc analytics --help

Global Options:
  --help      Show this help message
  --version   Show version information

Documentation: ./docs/
Repository: https://github.com/binhphap/mekong-cli
EOF
}

# Version info
show_version() {
    cat <<EOF
AgencyOS Unified CLI (cc) v${VERSION}

Modules:
EOF
    for module in "${!MODULES[@]}"; do
        echo "  - $module (${MODULES[$module]})"
    done | sort
    echo ""
    echo "Python: $($PYTHON --version 2>&1)"
    echo "Location: $SCRIPT_DIR"
}

# Main dispatch logic
main() {
    # Handle global flags
    if [[ $# -eq 0 ]] || [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        show_help
        exit 0
    fi

    if [[ "${1:-}" == "--version" ]] || [[ "${1:-}" == "-v" ]]; then
        show_version
        exit 0
    fi

    # Get module name
    local module="$1"
    shift

    # Validate module
    if [[ ! -v "MODULES[$module]" ]]; then
        echo "‚ùå Error: Unknown module '$module'" >&2
        echo "" >&2
        echo "Available modules: ${!MODULES[*]}" >&2
        echo "Run 'cc --help' for more information." >&2
        exit 1
    fi

    # Get module script
    local script="${MODULES[$module]}"
    local script_path="$SCRIPT_DIR/$script"

    # Validate script exists
    if [[ ! -f "$script_path" ]]; then
        echo "‚ùå Error: Module script not found: $script_path" >&2
        exit 1
    fi

    # Dispatch to module
    exec "$PYTHON" "$script_path" "$@"
}

main "$@"
